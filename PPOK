import streamlit as st
from datetime import datetime

# Konfigurasi halaman
st.set_page_config(page_title="Diagnosis PPOK", page_icon="ğŸ«", layout="wide")

# Basis Pengetahuan PPOK (diambil dari jurnal)
knowledge_base = {
    'G01': {'PPOK': 0.42, 'theta': 0.58},
    'G02': {'PPOK': 0.42, 'theta': 0.58},
    'G03': {'PPOK': 0.14, 'theta': 0.86},
    'G04': {'PPOK': 0.20, 'theta': 0.80},
    'G05': {'PPOK': 0.39, 'theta': 0.61},
    'G06': {'PPOK': 0.58, 'theta': 0.42},
    'G07': {'PPOK': 0.77, 'theta': 0.23},
    'G08': {'PPOK': 0.96, 'theta': 0.04},
    'G09': {'PPOK': 0.07, 'theta': 0.93},
    'G10': {'PPOK': 0.105, 'theta': 0.895},
    'G11': {'PPOK': 0.035, 'theta': 0.965},
    'G12': {'PPOK': 0.035, 'theta': 0.965},
    'G13': {'PPOK': 0.035, 'theta': 0.965},
    'G14': {'PPOK': 0.035, 'theta': 0.965},
    'G15': {'PPOK': 0.105, 'theta': 0.895},
    'G16': {'PPOK': 0.105, 'theta': 0.895},
    'G17': {'PPOK': 0.105, 'theta': 0.895},
    'G18': {'PPOK': 0.035, 'theta': 0.965},
}

symptom_names = {
    'G01': 'Batuk Berdahak > 3 bulan',
    'G02': 'Batuk Kronis > 3 bulan',
    'G03': 'Usia > 45 tahun',
    'G04': 'Sesak saat aktivitas berat',
    'G05': 'Sesak saat naik tangga',
    'G06': 'Berjalan lambat karena sesak',
    'G07': 'Sesak saat berjalan 100m',
    'G08': 'Sesak saat mandi/pakai baju',
    'G09': 'Nyeri di dada',
    'G10': 'Mengi (suara tinggi saat napas)',
    'G11': 'Merasa lelah',
    'G12': 'Penurunan berat badan',
    'G13': 'Aktivitas fisik berkurang',
    'G14': 'Keluar masuk RS dengan keluhan sama',
    'G15': 'Merokok > 15 tahun',
    'G16': 'Kerja di tempat polusi tinggi',
    'G17': 'Tinggal di daerah polusi tinggi',
    'G18': 'Terpapar asap rokok (pasif)',
}

possible_hypotheses = set(['PPOK', 'theta'])

# Fungsi Dempster-Shafer
def combine_mass(m1, m2):
    new_mass = {}
    conflict_k = 0
    for h1_str, val1 in m1.items():
        for h2_str, val2 in m2.items():
            h1 = set(h1_str.split(',')) if h1_str != 'theta' else possible_hypotheses
            h2 = set(h2_str.split(',')) if h2_str != 'theta' else possible_hypotheses
            intersection = h1.intersection(h2)
            if not intersection:
                conflict_k += val1 * val2
                continue
            new_h_str = ','.join(sorted(list(intersection)))
            if new_h_str == 'PPOK,theta':
                new_h_str = 'theta'
            new_mass[new_h_str] = new_mass.get(new_h_str, 0) + (val1 * val2)
    if conflict_k == 1:
        st.error("âŒ Terjadi konflik total antar bukti.")
        return {'theta': 1.0}
    denominator = 1 - conflict_k
    return {h: val / denominator for h, val in new_mass.items()}

# Header kotak
st.markdown("""
<div style='
    background-color: #e6f2ff;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #d0d0d0;
    display: flex;
    align-items: center;
    gap: 1rem;
'>
    <img src='https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/SARS-CoV-2_without_background.png/220px-SARS-CoV-2_without_background.png' width='60'>
    <div>
        <h2 style='margin-bottom: 0;'>ğŸ« Sistem Pakar Diagnosis PPOK</h2>
        <p style='margin-top: 5px; font-size: 16px; color: #333;'>Berbasis Dempster-Shafer â€¢ Akurat â€¢ Informatif</p>
    </div>
</div>
""", unsafe_allow_html=True)

# Input pengguna
st.markdown("### ğŸ§‘â€âš•ï¸ Data Pengguna")
col_nama, col_umur = st.columns([2, 1])
with col_nama:
    nama = st.text_input("Nama Lengkap")
with col_umur:
    umur = st.number_input("Umur", min_value=0, max_value=120, step=1)

# Pilih gejala
st.markdown("### ğŸ©º Pilih Gejala yang Kamu Alami")
selected_symptoms_map = {}
col1, col2 = st.columns(2)
items = list(symptom_names.items())
for i in range(0, len(items), 2):
    code1, name1 = items[i]
    with col1:
        selected_symptoms_map[code1] = st.checkbox(f"âœ… {name1}")
    if i + 1 < len(items):
        code2, name2 = items[i + 1]
        with col2:
            selected_symptoms_map[code2] = st.checkbox(f"âœ… {name2}")

st.markdown("---")
process_button = st.button("ğŸš€ Proses Diagnosis")

# Proses diagnosis
if process_button:
    selected_symptoms_list = [code for code, selected in selected_symptoms_map.items() if selected]
    gejala_terpilih = [symptom_names[c] for c in selected_symptoms_list]

    if not nama or umur == 0:
        st.warning("âš ï¸ Silakan isi nama dan umur terlebih dahulu.")
    elif len(selected_symptoms_list) < 3:
        st.warning("âš ï¸ Silakan pilih minimal tiga gejala.")
    else:
        result_mass = knowledge_base[selected_symptoms_list[0]]
        for i in range(1, len(selected_symptoms_list)):
            m2 = knowledge_base[selected_symptoms_list[i]]
            result_mass = combine_mass(result_mass, m2)

        belief_ppok = result_mass.get('PPOK', 0)
        belief_theta = result_mass.get('theta', 0)

        st.markdown("### ğŸ“Š Hasil Diagnosis")
        st.metric("ğŸ« Keyakinan PPOK", f"{belief_ppok * 100:.2f}%")
        st.progress(belief_ppok)
        st.metric("â” Ketidaktahuan (Theta)", f"{belief_theta * 100:.2f}%")
        st.progress(belief_theta)

        st.markdown("### ğŸ§¾ Detail Diagnosis")
        st.info(f"ğŸ•’ Waktu: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        st.info(f"ğŸ‘¤ Nama: {nama} | Umur: {umur} tahun")
        st.info(f"ğŸ©º Gejala: {', '.join(gejala_terpilih)}")

        st.markdown("### ğŸ©º Saran Kesehatan")

        if belief_ppok >= 0.625:
            st.success("ğŸŸ¢ Terdiagnosa PPOK")
            st.markdown("""
            âœ… **Saran:**  
            - Edukasi bahaya merokok dan polusi  
            - Segera berhenti merokok  
            - Lakukan latihan pernapasan dan olahraga ringan  
            - Konsumsi makanan bergizi  
            - Segera konsultasi ke dokter spesialis paru
            """)
        else:
            st.info("ğŸ›¡ï¸ Tidak terdiagnosa PPOK")
            st.markdown("""
            âš ï¸ **Saran Pencegahan:**  
            - Hindari paparan asap rokok dan polusi udara  
            - Jaga kebugaran dengan olahraga ringan  
            - Konsumsi makanan bergizi dan cukup istirahat  
            - Lakukan pemeriksaan rutin jika memiliki riwayat pernapasan
            """)

            
